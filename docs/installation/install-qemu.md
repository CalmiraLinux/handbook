# Установка системы в Qemu/KVM

Вы можете захотеть установить Calmira не на реальное железо, а в виртуальную машину Qemu/KVM. Создайте виртуальную машину со следующими параметрами:

1. Тип ОС: Generic Linux/Generic Default;
2. ЦП: qemu64/kvm64/копирующий конфигурацию ЦП хоста (в случае если на хосте процессор x86_64);
3. ОЗУ: 64 Мб;
4. Жёсткий диск: 1.5 Гб `qcow2`;
5. Шина диска: SATA;

Всё это создавалось в virt-manager. Параметры рекомендуемые.

## Монтирования

Теперь нужно скопировать распакованный в [этой](unpack/) инструкции дистрибутив в только что созданный образ жёсткого диска (образ сгенерировался во время создания виртуальной машины). Нужно смонтировать этот образ. Для этого подключите модуль `qemu-nbd` и смонтируйте образ ЖД:

```bash
# Подключение модуля ядра:
modprobe nbd max_part=8

# Подключение образа:
qemu-nbd --connect=/dev/nbd0 /var/lib/libvirt/images/$NAME.qcow2

fdisk /dev/nbd0 -l
mkdir /mnt/calm
```

Замените `$NAME` на имя виртуальной машины (и, по совместительству, имя диска).

## Разметка разделов

Необходимо разметить новый "жёсткий диск". Для этого выполните:

```bash
cfdisk /dev/nbd0
```

`cfdisk` запросит у вас таблицу разделов. Выбирайте `mbr` (она же `dos`) либо `gpt`. Разницы никакой нет, кроме той, что в случае `gpt` нужно в начале диска создать раздел объёмом 1 Мб с типом `biosboot` для корректной установки загрузчика.

Потом (и для gpt, и для mbr) создайте корневой раздел. Он должен занимать всё оставшееся место. Тип: Linux filesystem. При желании можете создать ещё и раздел со swap. Его объём должен равняться половине от объёма оперативной памяти (к примеру, в виртуальной машине установлено значение ОЗУ, равное 64 Мб. Для подкачки тогда нужно выбрать объём 32 Мб). Тип раздела с подкачкой: Linux swap.

## Форматирование разделов

После разметки отформатируйте нужные разделы. Для форматирования корневого раздела выполните:

```bash
mkfs.ext4 /dev/nbd0pX
```

Замените `nbd0pX` на нужную метку раздела. Обычно это `nbd0p1`, если используется `mbr`, либо `nbd0p2`, если `gpt`.

Если вы создали раздел подкачки:

```bash
mkswap /dev/nbd0pX
```

Заменив `nbd0pX` на нужную метку раздела.

## Копирование системы

Смонтируйте корневой раздел:

```bash
mount /dev/nbd0pX /mnt/calm
```

Замените `nbd0pX` на нужную метку раздела. Обычно это `nbd0p1`, если используется `mbr`, либо `nbd0p2`, если `gpt`.

После того, как смонтировали раздел, скопируйте на него данные из распакованного образа дистрибутива. Во-первых убедитесь, что находитесь в директории `squashfs-root`:

```bash
pwd
```

Если всё верно, переходите к копированию:

```bash
sudo cp -rvxa * /mnt/calm/
```

Во время копирования на экран будут выведены скопированные файлы. Внимательно прочитайте вывод: в нём не должно содержаться `error`, `fail` и пр. Если вы не хотите видеть подробный результат о каждом скопированном файле, то уберите ключ `-v` из команды. В таком случае на экран будут выведены сообщения об ошибках и предупреждения (если они есть).
